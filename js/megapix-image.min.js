(function(){function f(b){var d=b.naturalWidth,e=b.naturalHeight;if(d*e>1024*1024){var a=document.createElement("canvas");a.width=a.height=1;var c=a.getContext("2d");c.drawImage(b,-d+1,0);return c.getImageData(0,0,1,1).data[3]===0}else return false}function c(j,k,b){var c=document.createElement("canvas");c.width=1;c.height=b;var f=c.getContext("2d");f.drawImage(j,0,0);var i=f.getImageData(0,0,1,b).data,d=0,g=b,a=b;while(a>d){var h=i[(a-1)*4+3];if(h===0)g=a;else d=a;a=g+d>>1}var e=a/b;return e===0?1:e}function d(e,a,d){var c=document.createElement("canvas");b(e,c,a,d);return c.toDataURL("image/jpeg",a.quality||.8)}function b(d,n,j,w){var i=d.naturalWidth,h=d.naturalHeight,p=j.width,o=j.height,g=n.getContext("2d");g.save();e(n,g,p,o,j.orientation);var v=f(d);if(v){i/=2;h/=2}var a=1024,b=document.createElement("canvas");b.width=b.height=a;var k=b.getContext("2d"),u=w?c(d,i,h):1,r=Math.ceil(a*p/i),q=Math.ceil(a*o/h/u),m=0,t=0;while(m<h){var l=0,s=0;while(l<i){k.clearRect(0,0,a,a);k.drawImage(d,-l,-m);g.drawImage(b,0,0,a,a,s,t,r,q);l+=a;s+=r}m+=a;t+=q}g.restore();b=k=null}function e(d,a,c,b,e){switch(e){case 5:case 6:case 7:case 8:d.width=b;d.height=c;break;default:d.width=c;d.height=b}switch(e){case 2:a.translate(c,0);a.scale(-1,1);break;case 3:a.translate(c,b);a.rotate(Math.PI);break;case 4:a.translate(0,b);a.scale(1,-1);break;case 5:a.rotate(.5*Math.PI);a.scale(1,-1);break;case 6:a.rotate(.5*Math.PI);a.translate(0,-b);break;case 7:a.rotate(.5*Math.PI);a.translate(c,-b);a.scale(-1,1);break;case 8:a.rotate(-.5*Math.PI);a.translate(-c,0)}}function a(a){if(window.Blob&&a instanceof Blob){var c=new Image,d=window.URL&&window.URL.createObjectURL?window.URL:window.webkitURL&&window.webkitURL.createObjectURL?window.webkitURL:null;if(!d)throw Error("No createObjectURL function found to create blob url");c.src=d.createObjectURL(a);this.blob=a;a=c}if(!a.naturalWidth&&!a.naturalHeight){var b=this;a.onload=function(){var a=b.imageLoadListeners;if(a){b.imageLoadListeners=null;for(var c=0,d=a.length;c<d;c++)a[c]()}};this.imageLoadListeners=[]}this.srcImage=a}a.prototype.render=function(h,e){if(this.imageLoadListeners){var o=this;this.imageLoadListeners.push(function(){o.render(h,e)});return}e=e||{};var g=this.srcImage.naturalWidth,f=this.srcImage.naturalHeight,c=e.width,a=e.height,j=e.maxWidth,i=e.maxHeight,l=!this.blob||this.blob.type==="image/jpeg";if(c&&!a)a=f*c/g<<0;else if(a&&!c)c=g*a/f<<0;else{c=g;a=f}if(j&&c>j){c=j;a=f*c/g<<0}if(i&&a>i){a=i;c=g*a/f<<0}var k={width:c,height:a};for(var n in e)k[n]=e[n];var m=h.tagName.toLowerCase();if(m==="img")h.src=d(this.srcImage,k,l);else m==="canvas"&&b(this.srcImage,h,k,l);if(typeof this.onrender==="function")this.onrender(h)};if(typeof define==="function"&&define.amd)define([],function(){return a});else this.MegaPixImage=a;window.MegaPixImage=a})()